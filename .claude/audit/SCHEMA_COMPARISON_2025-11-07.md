# Schema Comparison: Frontend vs Backend

**Date**: 2025-11-07
**Purpose**: Document schema differences between frontend (localStorage) and backend (DynamoDB)

---

## Summary

**Frontend Convention**: `snake_case`
**Backend Convention**: `camelCase`
**Mapping Required**: YES (manual conversion in `syncFromCloud()`)
**Technical Debt**: MEDIUM - Every new field needs dual implementation

---

## Injection Schema

### Frontend (localStorage)
```javascript
{
    id: "id_abc123_1699876543210",              // Custom format: id_{random}_{timestamp}
    timestamp: "2025-11-07T10:00:00.000Z",      // ISO 8601
    dose_mg: 4.0,                                // snake_case
    injection_site: "left_thigh",                // snake_case
    vial_id: "vial-uuid",                        // snake_case, nullable
    weight_kg: 90.2,                             // snake_case, recently added
    weight_source: "manual",                     // snake_case
    notes: "",
    medication_level_at_injection: 12.5          // snake_case, computed, NOT synced
}
```

### Backend (DynamoDB)
```javascript
{
    PK: "USER#userId",
    SK: "INJECTION#uuid",
    GSI1PK: "USER#userId",
    GSI1SK: "TIMESTAMP#2025-11-07T10:00:00.000Z",
    id: "uuid-v4",                               // Generated by backend if not provided
    timestamp: "2025-11-07T10:00:00.000Z",
    doseMg: 4.0,                                 // camelCase
    site: "left_thigh",                          // camelCase, different name!
    vialId: "vial-uuid",                         // camelCase, nullable
    weightKg: 90.2,                              // camelCase, recently added
    notes: "",
    entityType: "INJECTION",
    createdAt: "2025-11-07T10:00:00.000Z",
    updatedAt: "2025-11-07T10:00:00.000Z"
}
```

### Field Mapping
| Frontend | Backend | Type | Notes |
|----------|---------|------|-------|
| `id` | `id` | string | ⚠️ Frontend uses custom format, backend uses UUID |
| `timestamp` | `timestamp` | string | ✅ Same |
| `dose_mg` | `doseMg` | number | ⚠️ Case difference |
| `injection_site` | `site` | string | ❌ Different names! |
| `vial_id` | `vialId` | string\|null | ⚠️ Case difference |
| `weight_kg` | `weightKg` | number | ⚠️ Case difference, recently added |
| `weight_source` | N/A | string | ❌ Frontend only |
| `notes` | `notes` | string | ✅ Same |
| `medication_level_at_injection` | N/A | number | ❌ Frontend only, computed |
| N/A | `createdAt` | string | ❌ Backend only |
| N/A | `updatedAt` | string | ❌ Backend only |
| N/A | `entityType` | string | ❌ Backend only (DynamoDB meta) |

### Issues
1. ❌ **Different field names**: `injection_site` vs `site` (error-prone)
2. ⚠️ **Case mismatch**: Requires mapping layer
3. ❌ **Frontend-only fields**: `weight_source`, `medication_level_at_injection` not synced
4. ⚠️ **ID format difference**: Custom vs UUID

---

## Vial Schema

### Frontend (localStorage)
```javascript
{
    vial_id: "id_xyz789_1699876543210",          // ❌ Uses 'vial_id' not 'id'!
    order_date: "2025-10-01",                     // snake_case
    total_mg: 15.0,                               // snake_case, computed
    bac_water_ml: 1.5,                            // snake_case
    concentration_mg_per_ml: 10.0,                // snake_case
    current_volume_ml: 1.2,                       // snake_case
    used_volume_ml: 0.3,                          // snake_case
    remaining_ml: 1.2,                            // ❌ COMPUTED, duplicates current_volume_ml
    doses_used: 3,                                // ❌ COMPUTED, not in backend
    status: "active",                             // ✅ Same
    supplier: "",                                 // frontend field name
    notes: "",
    reconstitution_date: "2025-10-15"             // snake_case
}
```

### Backend (DynamoDB)
```javascript
{
    PK: "USER#userId",
    SK: "VIAL#uuid",
    GSI1PK: "USER#userId",
    GSI1SK: "VIAL#2025-10-15",
    id: "uuid-v4",                                // ✅ Uses 'id'
    startDate: "2025-10-15",                      // camelCase
    initialVolumeMl: 1.5,                         // camelCase
    concentrationMgPerMl: 10.0,                   // camelCase
    currentVolumeMl: 1.2,                         // camelCase
    usedVolumeMl: 0.3,                            // camelCase
    status: "active",                             // ✅ Same
    source: "",                                   // backend field name
    notes: "",
    entityType: "VIAL",
    createdAt: "2025-10-15T00:00:00.000Z",
    updatedAt: "2025-11-07T12:20:00.000Z"
}
```

### Field Mapping
| Frontend | Backend | Type | Notes |
|----------|---------|------|-------|
| `vial_id` | `id` | string | ❌ **CRITICAL**: Different names cause major bugs |
| `order_date` | `startDate` | string | ❌ Different names |
| `reconstitution_date` | `startDate` | string | ⚠️ Same backend field, different frontend usage |
| `total_mg` | N/A | number | ❌ Frontend computed (not synced) |
| `bac_water_ml` | `initialVolumeMl` | number | ❌ Different names |
| `concentration_mg_per_ml` | `concentrationMgPerMl` | number | ⚠️ Case difference |
| `current_volume_ml` | `currentVolumeMl` | number | ⚠️ Case difference |
| `used_volume_ml` | `usedVolumeMl` | number | ⚠️ Case difference |
| `remaining_ml` | N/A | number | ❌ Frontend computed duplicate |
| `doses_used` | N/A | number | ❌ Frontend computed (not synced) |
| `status` | `status` | string | ✅ Same |
| `supplier` | `source` | string | ❌ Different names |
| `notes` | `notes` | string | ✅ Same |
| N/A | `createdAt` | string | ❌ Backend only |
| N/A | `updatedAt` | string | ❌ Backend only |

### Issues
1. ❌ **CRITICAL**: `vial_id` vs `id` inconsistency (all other entities use `id`)
2. ❌ **Multiple name mismatches**: `order_date` vs `startDate`, `supplier` vs `source`, `bac_water_ml` vs `initialVolumeMl`
3. ❌ **Computed fields stored**: `remaining_ml`, `doses_used`, `total_mg` calculated on frontend but not synced
4. ⚠️ **Normalization needed**: `normalizeVialData()` function added (Lines 2884-2910) converts API format to app format

---

## Weight Schema

### Frontend (localStorage)
```javascript
{
    id: "id_weight123_1699876543210",            // Custom format
    timestamp: "2025-11-07T08:00:00.000Z",
    weight_kg: 85.5,                              // snake_case
    notes: ""
}
```

### Backend (DynamoDB)
```javascript
{
    PK: "USER#userId",
    SK: "WEIGHT#uuid",
    GSI1PK: "USER#userId",
    GSI1SK: "TIMESTAMP#2025-11-07T08:00:00.000Z",
    id: "uuid-v4",
    timestamp: "2025-11-07T08:00:00.000Z",
    weightKg: 85.5,                               // camelCase
    notes: "",
    entityType: "WEIGHT",
    createdAt: "2025-11-07T08:00:00.000Z",
    updatedAt: "2025-11-07T08:00:00.000Z"
}
```

### Field Mapping
| Frontend | Backend | Type | Notes |
|----------|---------|------|-------|
| `id` | `id` | string | ⚠️ Format difference |
| `timestamp` | `timestamp` | string | ✅ Same |
| `weight_kg` | `weightKg` | number | ⚠️ Case difference |
| `notes` | `notes` | string | ✅ Same |
| N/A | `createdAt` | string | ❌ Backend only |
| N/A | `updatedAt` | string | ❌ Backend only |

### Issues
1. ⚠️ **Case mismatch**: `weight_kg` vs `weightKg`
2. ⚠️ **ID format difference**: Custom vs UUID

---

## Settings Schema (Not Synced)

### Frontend Only (localStorage)
```javascript
{
    height: 175,                                  // cm
    startWeight: 95.0,                           // kg
    goalWeight: 75.0,                            // kg
    doseIncrement: 0.5,                          // mg
    theme: "dark",
    notifications: true,
    weeklyGoal: 0.5                              // kg/week
}
```

**Note**: Settings are NOT synced to cloud (localStorage only)

---

## Mapping Layer Analysis

### Location
`index.html:2984-3012` (function `syncFromCloud`)

### Current Implementation
```javascript
// API → App conversion (Lines 2984-3012)
const convertedInjections = cloudInjections.map(inj => ({
    id: inj.id,
    timestamp: inj.timestamp,
    dose_mg: inj.doseMg,                          // camelCase → snake_case
    injection_site: inj.site,                     // Different name!
    vial_id: inj.vialId,                          // camelCase → snake_case
    weight_kg: inj.weightKg,                      // camelCase → snake_case
    notes: inj.notes
}));

const convertedVials = cloudVials.map(vial => ({
    vial_id: vial.id,                             // id → vial_id
    reconstitution_date: vial.startDate,
    total_mg: vial.initialVolumeMl * vial.concentrationMgPerMl,  // Computed!
    bac_water_ml: vial.initialVolumeMl,
    concentration_mg_per_ml: vial.concentrationMgPerMl,
    current_volume_ml: vial.currentVolumeMl,
    used_volume_ml: vial.usedVolumeMl,
    status: vial.status,
    supplier: vial.source,
    notes: vial.notes
}));

const convertedWeights = cloudWeights.map(weight => ({
    id: weight.id,
    timestamp: weight.timestamp,
    weight_kg: weight.weightKg,                   // camelCase → snake_case
    notes: weight.notes
}));
```

### Issues with Current Mapping
1. **Maintenance Burden**: Every new field needs manual addition to mapper
2. **Error-Prone**: Easy to forget updating mapper (causes data loss)
3. **Computed Fields**: Some fields calculated during mapping (`total_mg`)
4. **No Validation**: Mapper doesn't validate data shape
5. **No Type Safety**: No TypeScript, errors only caught at runtime

---

## Controlled Vocabularies

### Injection Sites

**Frontend Accepts**: (from validation, Line 4292)
```javascript
const validSites = [
    'left_thigh', 'right_thigh',
    'left_arm', 'right_arm',
    'abdomen_left', 'abdomen_right'
];
```

**Backend Accepts**: (`lambda/injections/post.js:56-60`)
```javascript
const validSites = [
    'left_thigh', 'right_thigh',
    'left_arm', 'right_arm',
    'abdomen_left', 'abdomen_right'
];
```

**Status**: ✅ Synchronized (after recent fix)

**Historical Issue**: Frontend previously accepted:
- `"abdomen"` (no side specified)
- `"right abdomen"` (space instead of underscore)

**Fix Applied**: Today - manual mapping to valid values in DynamoDB

### Vial Status

**Frontend**: (inferred from UI)
```javascript
'active'      // Being used
'finished'    // Depleted
'dry'         // Not yet reconstituted
'empty'       // Synonym for finished (?)
```

**Backend**: (`lambda/vials/post.js` - not explicitly validated)
```javascript
// Accepts any string (no enum validation)
```

**Issue**: ⚠️ No backend validation on vial status
**Risk**: MEDIUM - Could accept invalid status values

---

## ID Generation Differences

### Frontend ID Format
```javascript
// Line 3501-3503
generateId() {
    const randomStr = Math.random().toString(36).substring(2, 10);
    return `id_${randomStr}_${Date.now()}`;
}
```
**Format**: `"id_{8-char-random}_{timestamp}"`
**Example**: `"id_abc12345_1699876543210"`

### Backend ID Format
```javascript
// Lambda: Uses crypto.randomUUID()
const { randomUUID } = require('crypto');
const id = randomUUID();
```
**Format**: UUID v4
**Example**: `"f47ac10b-58cc-4372-a567-0e02b2c3d479"`

### Implications
1. **Frontend IDs are predictable** (timestamp + weak random)
2. **Backend IDs are cryptographically secure** (UUID v4)
3. **No ID collision risk** (different formats)
4. **But**: Inconsistent ID format across entities

---

## Recommendations

### Priority 1: Unify Naming Convention (P1)

**Goal**: Eliminate snake_case vs camelCase mapping

**Approach**: Migrate frontend to camelCase (matches backend)

**Migration Steps**:
1. Update all frontend code to use camelCase field names
2. Create migration script for localStorage data:
```javascript
function migrateLocalStorageToLowerCamelCase() {
    const data = JSON.parse(localStorage.getItem('injection_data'));

    // Migrate injections
    data.injections = data.injections.map(inj => ({
        id: inj.id,
        timestamp: inj.timestamp,
        doseMg: inj.dose_mg,                      // snake → camel
        site: inj.injection_site,                 // Also rename!
        vialId: inj.vial_id,                      // snake → camel
        weightKg: inj.weight_kg,                  // snake → camel
        weightSource: inj.weight_source,          // snake → camel
        notes: inj.notes,
        medicationLevelAtInjection: inj.medication_level_at_injection
    }));

    // Migrate vials
    data.vials = data.vials.map(vial => ({
        id: vial.vial_id,                         // Also rename!
        startDate: vial.reconstitution_date || vial.order_date,
        totalMg: vial.total_mg,
        initialVolumeMl: vial.bac_water_ml,
        concentrationMgPerMl: vial.concentration_mg_per_ml,
        currentVolumeMl: vial.current_volume_ml,
        usedVolumeMl: vial.used_volume_ml,
        status: vial.status,
        source: vial.supplier,
        notes: vial.notes
    }));

    // Migrate weights
    data.weights = data.weights.map(weight => ({
        id: weight.id,
        timestamp: weight.timestamp,
        weightKg: weight.weight_kg,               // snake → camel
        notes: weight.notes
    }));

    // Save migrated data
    localStorage.setItem('injection_data', JSON.stringify(data));
    localStorage.setItem('migration_v2_complete', 'true');
}
```

3. Run migration on app load (one-time):
```javascript
if (!localStorage.getItem('migration_v2_complete')) {
    migrateLocalStorageToLowerCamelCase();
}
```

4. Remove mapping layer in `syncFromCloud()` (Lines 2984-3012)

**Effort**: 2-3 days
**Risk**: MEDIUM (requires data migration)
**Benefit**: Eliminates maintenance burden, reduces bugs

### Priority 2: Fix Vial ID Inconsistency (P1)

**Issue**: Vials use `vial_id`, all other entities use `id`

**Solution**: Rename `vial_id` → `id` everywhere

**Impact**: HIGH - Affects many calculations and references

**Migration**:
```javascript
// Update all vial references
data.vials.forEach(vial => {
    vial.id = vial.vial_id;
    delete vial.vial_id;
});

// Update injection references
data.injections.forEach(inj => {
    if (inj.vial_id) {
        inj.vialId = inj.vial_id;  // Also camelCase!
        delete inj.vial_id;
    }
});
```

**Effort**: 0.5-1 day
**Risk**: MEDIUM (many code locations)

### Priority 3: Standardize ID Generation (P2)

**Options**:
1. **Use backend IDs only** (recommended)
   - Frontend generates temporary ID
   - Backend returns UUID
   - Frontend replaces temp ID with UUID

2. **Use frontend IDs only**
   - Backend accepts frontend-provided ID
   - Current implementation (already works)

**Recommended**: Option 2 (no change needed)

**Reasoning**: Frontend IDs work fine, backend already accepts them

### Priority 4: Add Backend Validation for Enums (P2)

**Issue**: Vial status not validated on backend

**Solution**: Add validation in `lambda/vials/post.js`:
```javascript
const validStatuses = ['active', 'finished', 'dry', 'empty'];
if (!validStatuses.includes(body.status)) {
    return {
        statusCode: 400,
        body: JSON.stringify({
            success: false,
            error: `status must be one of: ${validStatuses.join(', ')}`
        })
    };
}
```

**Effort**: 0.5 day
**Risk**: LOW

---

## Schema Evolution Tracking

### Recent Changes (2025-11-07)
1. ✅ **Added `weightKg` to injections** (both frontend and backend)
   - Purpose: Enable weight tracking on Results graphs
   - Method: Manual DynamoDB updates for historical data
   - Status: Complete

2. ✅ **Fixed injection site validation** (frontend and backend)
   - Purpose: Standardize site values
   - Method: Mapping old values to valid enum
   - Status: Complete

3. ✅ **Added 2 dry stock vials** (backend)
   - Purpose: Inventory management
   - Method: Manual DynamoDB inserts
   - Status: Complete

### Deprecated Fields
- `remaining_ml` on vials (duplicates `current_volume_ml`)
- `weight_source` on injections (unused)
- `medication_level_at_injection` (recalculated on demand)

### Future Additions (Proposed)
- `sync_status` on all entities (for sync queue)
- `sync_error` on all entities (error message storage)
- `version` on all entities (for conflict resolution)
- `deleted` on all entities (soft delete support)
- `deleted_at` on all entities (soft delete timestamp)

---

## Conclusion

**Current Schema Consistency**: 78/100

**Major Gaps**:
1. snake_case vs camelCase (frontend vs backend)
2. Inconsistent ID field names (vials use `vial_id`)
3. Multiple field name mismatches (site, source, startDate, etc.)
4. No validation on some enums (vial status)
5. Computed fields stored on frontend but not synced

**Recommended Path Forward**:
1. Week 1: Migrate frontend to camelCase (P1)
2. Week 1: Fix vial ID inconsistency (P1)
3. Week 2: Add backend enum validation (P2)
4. Week 2: Standardize computed fields (decide whether to sync or calculate)

**Estimated Effort**: 3-5 days

**Expected Outcome**: 95/100 schema consistency, elimination of mapping layer
