name: Deploy Frontend to AWS

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy-frontend:
    name: Deploy Frontend (S3 + CloudFront)
    runs-on: ubuntu-latest
    # Only run if PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Sync version numbers
        run: |
          echo "üî¢ Syncing version numbers from package.json..."
          npm ci
          npm run sync-version
          echo "‚úÖ Version sync complete"

      - name: Run tests before deployment
        run: |
          echo "üß™ Running test suite before deployment..."
          npx playwright install --with-deps chromium
          npm test
          echo "‚úÖ All tests passed"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Upload Frontend to S3
        run: |
          echo "üì§ Uploading frontend files to S3..."

          # Upload main files
          aws s3 cp index.html s3://retatrutide-frontend-372208783486/ \
            --region eu-west-1
          aws s3 cp manifest.json s3://retatrutide-frontend-372208783486/ \
            --region eu-west-1
          aws s3 cp robots.txt s3://retatrutide-frontend-372208783486/ \
            --region eu-west-1

          # Sync js directory
          aws s3 sync js/ s3://retatrutide-frontend-372208783486/js/ \
            --region eu-west-1 \
            --delete

          echo "‚úÖ Upload complete (index.html, manifest.json, robots.txt, js/)"

      - name: Invalidate CloudFront cache
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id E2ZD0ACBBK8F5K \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "‚úÖ Invalidation started: $INVALIDATION_ID"
          echo "invalidation_id=$INVALIDATION_ID" >> $GITHUB_OUTPUT
        id: invalidate

      - name: Wait for cache invalidation
        run: |
          echo "‚è≥ Waiting for cache invalidation to complete..."
          echo "This usually takes 2-5 minutes"
          aws cloudfront wait invalidation-completed \
            --distribution-id E2ZD0ACBBK8F5K \
            --id ${{ steps.invalidate.outputs.invalidation_id }}
          echo "‚úÖ Cache invalidation complete"

      - name: Deployment summary
        run: |
          echo "üéâ Frontend deployment successful!"
          echo ""
          echo "Your app is now live at:"
          echo "https://d13m7vzwjqe4pp.cloudfront.net"
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
