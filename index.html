<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Retatrutide Tracker</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Retatrutide Tracker">
    <meta name="description" content="Comprehensive Retatrutide injection tracker with vial management and weight tracking">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Crect width='32' height='32' fill='%231a1a1a'/%3E%3Ctext x='50%25' y='50%25' font-family='sans-serif' font-size='16' fill='white' text-anchor='middle' dominant-baseline='central'%3ESR%3C/text%3E%3C/svg%3E">

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --card-bg: #2a2a2a;
            --border-color: #333333;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --accent-color: #007AFF;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --danger-color: #FF3B30;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: 80px;
            line-height: 1.5;
        }

        /* Header Styles */
        #app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            height: 60px;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-md);
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .menu-btn, .add-shot-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-shot-btn {
            background-color: var(--accent-color);
            color: white;
            font-weight: 600;
            font-size: 14px;
            padding: var(--spacing-sm) var(--spacing-md);
        }

        .menu-btn:hover, .add-shot-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .add-shot-btn:hover {
            background-color: #0056b3;
        }

        .date-display {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        /* Main Content */
        #main-content {
            margin-top: 60px;
            min-height: calc(100vh - 140px);
        }

        .container {
            padding: var(--spacing-lg) var(--spacing-md);
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Responsive design */
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .results-stats {
                grid-template-columns: repeat(4, 1fr);
            }

            .inventory-stats {
                grid-template-columns: repeat(4, 1fr);
            }

            .chart-container, .supply-forecast-container {
                padding: var(--spacing-xl);
            }

            .chart-container canvas {
                max-height: 600px;
            }

            .shot-item, .vial-item {
                padding: var(--spacing-lg);
            }

            .form-container {
                max-width: 600px;
                margin: 0 auto;
            }

            .countdown-container {
                max-width: 600px;
                margin: 0 auto var(--spacing-lg);
            }
        }

        /* Tablet specific */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                max-width: 90%;
            }
        }

        /* Large desktop */
        @media (min-width: 1200px) {
            .tab-content {
                max-width: 1000px;
                margin: 0 auto;
            }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 140px);
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            text-align: center;
            transition: background-color 0.2s;
        }

        .stat-card:hover {
            background-color: #353535;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Chart Container */
        .chart-container, .supply-forecast-container {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .chart-container h3, .supply-forecast-container h3 {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .chart-container canvas {
            max-height: 450px;
            width: 100% !important;
            height: auto !important;
        }

        .supply-forecast {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .forecast-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .forecast-row:last-child {
            border-bottom: none;
        }

        .forecast-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .forecast-value {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .forecast-input-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .forecast-input {
            width: 60px;
            padding: var(--spacing-xs);
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .forecast-unit {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Countdown Container */
        .countdown-container {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .countdown-container h3 {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .countdown-circle {
            position: relative;
            display: inline-block;
        }

        .countdown-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .countdown-days {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1;
        }

        .countdown-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .countdown-time {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .countdown-progress {
            width: 200px;
            height: 200px;
        }

        .countdown-progress circle {
            transition: stroke-dashoffset 1s ease;
        }

        /* Buttons */
        .btn-primary, .btn-secondary {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: var(--spacing-sm);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary:hover {
            background-color: #353535;
        }

        /* Shots List */
        .shots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .shots-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .shots-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .shot-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            transition: background-color 0.2s;
        }

        .shot-item:hover {
            background-color: #353535;
        }

        .shot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .shot-dose {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .shot-date {
            font-size: 14px;
            color: var(--text-muted);
        }

        .shot-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Results Stats */
        .results-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .result-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .result-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--success-color);
            margin-bottom: var(--spacing-xs);
        }

        .result-label {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Inventory */
        .inventory-header {
            margin-bottom: var(--spacing-lg);
        }

        .vials-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .vial-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
        }

        .vial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .vial-status {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .vial-status.active {
            background-color: var(--success-color);
            color: white;
        }

        .vial-status.expired {
            background-color: var(--danger-color);
            color: white;
        }

        .vial-status.expiring {
            background-color: var(--warning-color);
            color: white;
        }

        .vial-status.empty {
            background-color: var(--text-muted);
            color: white;
        }

        .vial-info {
            flex: 1;
        }

        .vial-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .vial-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .vial-details {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .vial-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .vial-detail-row span:first-child {
            color: var(--text-muted);
            font-weight: 500;
        }

        .vial-detail-row span:last-child {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .inventory-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        /* Inventory Analytics */
        .inventory-analytics {
            margin-top: var(--spacing-xl);
        }

        .inventory-analytics h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .analytics-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
        }

        .analytics-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-content {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .inventory-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .inventory-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--warning-color);
            margin-bottom: var(--spacing-xs);
        }

        .inventory-label {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Settings */
        .settings-section {
            margin-bottom: var(--spacing-xl);
        }

        .settings-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .settings-section label {
            display: block;
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
        }

        .settings-section select,
        .settings-section input[type="number"],
        .settings-section input[type="text"] {
            width: 100%;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-md);
            color: var(--text-primary);
            font-size: 16px;
            margin-top: var(--spacing-sm);
        }

        .settings-section input[type="checkbox"] {
            width: auto;
            margin-left: var(--spacing-sm);
            transform: scale(1.2);
        }

        .btn-secondary.connected {
            background-color: var(--success-color);
            color: white;
        }

        .sync-status {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .modal-content {
            padding: var(--spacing-lg);
        }

        .modal-content p,
        .modal-content li {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .modal-content a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .modal-content a:hover {
            text-decoration: underline;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-sm) 0;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            transition: color 0.2s;
            min-width: 60px;
        }

        .nav-btn.active {
            color: var(--accent-color);
        }

        .nav-btn:hover {
            color: var(--text-primary);
        }

        .nav-btn.active:hover {
            color: var(--accent-color);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: var(--spacing-xs);
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            margin: var(--spacing-md);
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: var(--spacing-xs);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-md);
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: var(--spacing-md) var(--spacing-sm);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .header-content {
                padding: 0 var(--spacing-sm);
            }

            .shot-details {
                grid-template-columns: 1fr;
            }

            .results-stats,
            .inventory-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 2s infinite;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .mb-0 { margin-bottom: 0; }
        .mb-sm { margin-bottom: var(--spacing-sm); }
        .mb-md { margin-bottom: var(--spacing-md); }
        .mb-lg { margin-bottom: var(--spacing-lg); }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-column { flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
    </style>
</head>
<body>
    <!-- Header -->
    <header id="app-header">
        <div class="header-content">
            <button id="menu-btn" class="menu-btn">‚ò∞</button>
            <div class="date-display" id="current-date"></div>
            <button id="add-shot-btn" class="add-shot-btn">+ Shot</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content">
        <div class="loading" id="loading-screen">
            Loading Retatrutide Tracker...
        </div>

        <!-- Summary Tab -->
        <div id="summary-tab" class="tab-content" style="display: none;">
            <div class="container">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-shots">0</div>
                        <div class="stat-label">Total Shots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="last-dose">0 mg</div>
                        <div class="stat-label">Last Dose</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="current-level">0%</div>
                        <div class="stat-label">Current Level</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="next-shot">0 days</div>
                        <div class="stat-label">Next Shot</div>
                    </div>
                </div>

                <div class="countdown-container">
                    <h3>Next Shot Countdown</h3>
                    <div class="countdown-circle">
                        <div class="countdown-content">
                            <div class="countdown-days" id="countdown-days">0</div>
                            <div class="countdown-label">days</div>
                            <div class="countdown-time" id="countdown-time">00:00:00</div>
                        </div>
                        <svg class="countdown-progress" width="200" height="200">
                            <circle cx="100" cy="100" r="90" stroke="#333333" stroke-width="8" fill="none"/>
                            <circle id="countdown-circle" cx="100" cy="100" r="90" stroke="#007AFF" stroke-width="8"
                                    fill="none" stroke-linecap="round" transform="rotate(-90 100 100)"
                                    stroke-dasharray="565.48" stroke-dashoffset="0"/>
                        </svg>
                    </div>
                </div>

                <div class="supply-forecast-container">
                    <h3>Supply Forecast</h3>
                    <div class="supply-forecast">
                        <div class="forecast-row">
                            <span class="forecast-label">Total Supply:</span>
                            <span class="forecast-value" id="total-supply">0 mg</span>
                        </div>
                        <div class="forecast-row">
                            <span class="forecast-label">Planned Weekly Dose:</span>
                            <div class="forecast-input-group">
                                <input type="number" id="planned-dose" step="0.5" min="0" max="20" value="4.0" class="forecast-input">
                                <span class="forecast-unit">mg</span>
                            </div>
                        </div>
                        <div class="forecast-row">
                            <span class="forecast-label">Supply Will Last:</span>
                            <span class="forecast-value" id="supply-duration">0 weeks</span>
                        </div>
                        <div class="forecast-row">
                            <span class="forecast-label">Estimated Run Out Date:</span>
                            <span class="forecast-value" id="run-out-date">--</span>
                        </div>
                        <div class="forecast-row">
                            <span class="forecast-label">Days Until Reorder:</span>
                            <span class="forecast-value" id="reorder-days">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shots Tab -->
        <div id="shots-tab" class="tab-content" style="display: none;">
            <div class="container">
                <div class="shots-header">
                    <h2>Shot History</h2>
                    <button id="add-shot-modal-btn" class="btn-primary">Add Shot</button>
                </div>
                <div id="shots-list" class="shots-list"></div>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results-tab" class="tab-content" style="display: none;">
            <div class="container">
                <h2>Weight & Progress</h2>
                <div class="chart-container">
                    <canvas id="weight-chart"></canvas>
                </div>
                <div class="results-stats">
                    <div class="result-card">
                        <div class="result-value" id="weight-change">0 kg</div>
                        <div class="result-label">Weight Change</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="current-weight">0 kg</div>
                        <div class="result-label">Current Weight</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory-tab" class="tab-content" style="display: none;">
            <div class="container">
                <h2>Vial Management</h2>
                <div class="inventory-header">
                    <button id="add-vial-btn" class="btn-primary">Add Vial</button>
                </div>
                <div id="vials-list" class="vials-list"></div>
                <div class="inventory-stats">
                    <div class="inventory-card">
                        <div class="inventory-value" id="total-stock">0</div>
                        <div class="inventory-label">Doses in Stock</div>
                    </div>
                    <div class="inventory-card">
                        <div class="inventory-value" id="days-remaining">0</div>
                        <div class="inventory-label">Days Remaining</div>
                    </div>
                </div>

                <div class="inventory-analytics">
                    <h3>Inventory Analytics</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-title">Reorder Alert</div>
                            <div class="analytics-content" id="reorder-alert">
                                Stock levels look good
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-title">Usage Rate</div>
                            <div class="analytics-content" id="usage-rate">
                                Calculating...
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-title">Waste Tracking</div>
                            <div class="analytics-content" id="waste-tracking">
                                No expired vials
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-title">Next Order</div>
                            <div class="analytics-content" id="next-order">
                                Order in 30+ days
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content" style="display: none;">
            <div class="container">
                <h2>Settings</h2>
                <div class="settings-section">
                    <h3>Cloud Sync</h3>
                    <button id="google-drive-btn" class="btn-secondary">Connect Google Drive</button>
                    <button id="withings-btn" class="btn-secondary">Connect Withings</button>
                </div>
                <div class="settings-section">
                    <h3>Injection Schedule</h3>
                    <label>
                        Injection Frequency:
                        <select id="injection-frequency">
                            <option value="7">Weekly</option>
                            <option value="14">Bi-weekly</option>
                            <option value="21">Every 3 weeks</option>
                            <option value="28">Monthly</option>
                        </select>
                    </label>
                    <label>
                        Default Dose (mg):
                        <input type="number" id="default-dose" step="0.1" min="0" max="50" value="2.0">
                    </label>
                    <label>
                        Height (cm) for BMI:
                        <input type="number" id="user-height" step="0.1" min="0" max="300" placeholder="Enter height">
                    </label>
                    <label>
                        Enable Notifications:
                        <input type="checkbox" id="enable-notifications" checked>
                    </label>
                </div>
                <div class="settings-section">
                    <h3>Data Management</h3>
                    <button id="export-data-btn" class="btn-secondary">Export Data</button>
                    <button id="import-data-btn" class="btn-secondary">Import Data</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="bottom-nav">
        <button class="nav-btn active" data-tab="summary">
            <span class="nav-icon">üìä</span>
            <span class="nav-label">Summary</span>
        </button>
        <button class="nav-btn" data-tab="shots">
            <span class="nav-icon">üíâ</span>
            <span class="nav-label">Shots</span>
        </button>
        <button class="nav-btn" data-tab="results">
            <span class="nav-icon">üìà</span>
            <span class="nav-label">Results</span>
        </button>
        <button class="nav-btn" data-tab="inventory">
            <span class="nav-icon">üì¶</span>
            <span class="nav-label">Inventory</span>
        </button>
        <button class="nav-btn" data-tab="settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">Settings</span>
        </button>
    </nav>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <!-- Add Shot Modal -->
        <div id="add-shot-modal" class="modal" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Add New Shot</h3>
                <button class="modal-close" data-modal="add-shot-modal">&times;</button>
            </div>
            <form id="add-shot-form">
                <div class="form-group">
                    <label for="shot-date">Date & Time</label>
                    <input type="datetime-local" id="shot-date" required>
                </div>
                <div class="form-group">
                    <label for="shot-dose">Dose (mg)</label>
                    <input type="number" id="shot-dose" step="0.1" min="0" max="50" required>
                </div>
                <div class="form-group">
                    <label for="shot-site">Injection Site</label>
                    <select id="shot-site" required>
                        <option value="">Select injection site</option>
                        <option value="left_thigh">Left Thigh</option>
                        <option value="right_thigh">Right Thigh</option>
                        <option value="left_arm">Left Arm</option>
                        <option value="right_arm">Right Arm</option>
                        <option value="abdomen_left">Abdomen Left</option>
                        <option value="abdomen_right">Abdomen Right</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shot-vial">Vial</label>
                    <select id="shot-vial" required>
                        <option value="">Select vial</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shot-weight">Weight (kg) - Optional</label>
                    <input type="number" id="shot-weight" step="0.1" min="0" max="500">
                </div>
                <div class="form-group">
                    <label for="shot-notes">Notes - Optional</label>
                    <textarea id="shot-notes" placeholder="Side effects, timing, etc."></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn-primary">Add Shot</button>
                    <button type="button" class="btn-secondary" data-modal="add-shot-modal">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Add Vial Modal -->
        <div id="add-vial-modal" class="modal" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Add New Vial</h3>
                <button class="modal-close" data-modal="add-vial-modal">&times;</button>
            </div>
            <form id="add-vial-form">
                <div class="form-group">
                    <label for="vial-order-date">Order Date</label>
                    <input type="date" id="vial-order-date" required>
                </div>
                <div class="form-group">
                    <label for="vial-supplier">Supplier</label>
                    <input type="text" id="vial-supplier" placeholder="Pharmacy name">
                </div>
                <div class="form-group">
                    <label for="vial-lot">Lot Number</label>
                    <input type="text" id="vial-lot" placeholder="LOT123456">
                </div>
                <div class="form-group">
                    <label for="vial-mg">Total mg</label>
                    <input type="number" id="vial-mg" step="0.1" min="0" required placeholder="15">
                </div>
                <div class="form-group">
                    <label for="vial-bac-water">BAC Water (ml)</label>
                    <input type="number" id="vial-bac-water" step="0.1" min="0" required placeholder="1.5">
                </div>
                <div class="form-group">
                    <label for="vial-reconstitution-date">Reconstitution Date</label>
                    <input type="datetime-local" id="vial-reconstitution-date" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn-primary">Add Vial</button>
                    <button type="button" class="btn-secondary" data-modal="add-vial-modal">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Add Weight Modal -->
        <div id="add-weight-modal" class="modal" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Add Weight Entry</h3>
                <button class="modal-close" data-modal="add-weight-modal">&times;</button>
            </div>
            <form id="add-weight-form">
                <div class="form-group">
                    <label for="weight-date">Date & Time</label>
                    <input type="datetime-local" id="weight-date" required>
                </div>
                <div class="form-group">
                    <label for="weight-kg">Weight (kg)</label>
                    <input type="number" id="weight-kg" step="0.1" min="0" max="500" required>
                </div>
                <div class="form-group">
                    <label for="weight-body-fat">Body Fat % - Optional</label>
                    <input type="number" id="weight-body-fat" step="0.1" min="0" max="100">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn-primary">Add Weight</button>
                    <button type="button" class="btn-secondary" data-modal="add-weight-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ====================================
        // DATA STRUCTURES & STORAGE SYSTEM
        // ====================================

        class RetatrutideTracker {
            constructor() {
                this.data = {
                    injections: [],
                    vials: [],
                    weights: [],
                    settings: {
                        injectionFrequency: 7,
                        heightCm: null,
                        units: 'metric',
                        notifications: true,
                        googleDriveConnected: false,
                        withingsConnected: false,
                        lastSync: null
                    }
                };
                this.charts = {};
                this.init();
            }

            // Initialize the application
            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.updateUI();
                this.startCountdownTimer();
                this.hideLoadingScreen();
            }

            // ====================================
            // DATA MANAGEMENT
            // ====================================

            async loadData() {
                try {
                    const stored = localStorage.getItem('retatrutide_data');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.data = { ...this.data, ...data };
                    } else {
                        // Check if we should load sample data (not in test mode)
                        const urlParams = new URLSearchParams(window.location.search);
                        if (!urlParams.get('test')) {
                            // Load sample data for demo purposes
                            this.loadSampleData();
                        }
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    // Load sample data if there's an error (unless in test mode)
                    const urlParams = new URLSearchParams(window.location.search);
                    if (!urlParams.get('test')) {
                        this.loadSampleData();
                    }
                }
            }

            loadSampleData() {
                const now = new Date();

                // Add a sample vial
                const sampleVial = {
                    order_date: new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 15 days ago
                    supplier: 'Sample Pharmacy',
                    lot_number: 'LOT123456',
                    total_mg: 15,
                    bac_water_ml: 1.5,
                    reconstitution_date: new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString() // 10 days ago
                };

                this.addVial(sampleVial);

                // Add sample weights
                for (let i = 0; i < 8; i++) {
                    const weightDate = new Date(now.getTime() - (i * 3.5 * 24 * 60 * 60 * 1000)); // Every 3.5 days
                    this.addWeight({
                        timestamp: weightDate.toISOString(),
                        weight_kg: 85 - (i * 0.3) + (Math.random() * 0.4 - 0.2), // Gradual weight loss with some variation
                        source: 'manual'
                    });
                }

                // Add sample injections
                for (let i = 0; i < 4; i++) {
                    const injectionDate = new Date(now.getTime() - (i * 7 * 24 * 60 * 60 * 1000)); // Weekly
                    const vialId = this.data.vials[0]?.vial_id;
                    if (vialId) {
                        this.data.injections.push({
                            id: this.generateId(),
                            timestamp: injectionDate.toISOString(),
                            dose_mg: 1.0 + (i * 0.5), // Progressive dose increase
                            injection_site: ['left_thigh', 'right_thigh', 'left_arm', 'right_arm'][i % 4],
                            vial_id: vialId,
                            weight_kg: null,
                            weight_source: 'manual',
                            notes: i === 0 ? 'First injection - no side effects' : '',
                            medication_level_at_injection: 0
                        });
                        this.updateVialUsage(vialId, 1.0 + (i * 0.5));
                    }
                }

                this.data.injections.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Save the sample data to localStorage
                this.saveData();
            }

            async saveData() {
                try {
                    localStorage.setItem('retatrutide_data', JSON.stringify(this.data));
                    if (this.data.settings.googleDriveConnected) {
                        await this.syncToGoogleDrive();
                    }
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            }

            // ====================================
            // INJECTION MANAGEMENT
            // ====================================

            addInjection(injection) {
                const newInjection = {
                    id: this.generateId(),
                    timestamp: injection.timestamp || new Date().toISOString(),
                    dose_mg: parseFloat(injection.dose_mg),
                    injection_site: injection.injection_site,
                    vial_id: injection.vial_id,
                    weight_kg: injection.weight_kg ? parseFloat(injection.weight_kg) : null,
                    weight_source: injection.weight_source || 'manual',
                    notes: injection.notes || '',
                    medication_level_at_injection: this.calculateCurrentMedicationLevel(injection.timestamp)
                };

                this.data.injections.push(newInjection);
                this.data.injections.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                this.updateVialUsage(injection.vial_id, injection.dose_mg);
                this.saveData();
                this.updateUI();
            }

            updateVialUsage(vialId, doseMg) {
                const vial = this.data.vials.find(v => v.vial_id === vialId);
                if (vial) {
                    const doseVolumeML = doseMg / vial.concentration_mg_ml;
                    vial.remaining_ml = Math.max(0, vial.remaining_ml - doseVolumeML);
                    vial.doses_used++;

                    // Check if vial has less than next required dose
                    const plannedDose = parseFloat(document.getElementById('planned-dose')?.value || 4.0);
                    const remainingMg = vial.remaining_ml * vial.concentration_mg_ml;

                    if (remainingMg < plannedDose && remainingMg > 0) {
                        // Mark vial as empty if it can't provide the next dose
                        vial.status = 'insufficient';
                        vial.remaining_ml = 0;
                    } else if (vial.remaining_ml <= 0) {
                        vial.status = 'empty';
                    }
                }
            }

            // ====================================
            // VIAL MANAGEMENT
            // ====================================

            addVial(vial) {
                const concentration = vial.total_mg / vial.bac_water_ml;
                const newVial = {
                    vial_id: this.generateId(),
                    order_date: vial.order_date,
                    supplier: vial.supplier || '',
                    lot_number: vial.lot_number || '',
                    total_mg: parseFloat(vial.total_mg),
                    bac_water_ml: parseFloat(vial.bac_water_ml),
                    concentration_mg_ml: concentration,
                    reconstitution_date: vial.reconstitution_date,
                    expiration_date: this.calculateExpirationDate(vial.reconstitution_date, vial.order_date),
                    remaining_ml: parseFloat(vial.bac_water_ml),
                    doses_used: 0,
                    status: 'active'
                };

                this.data.vials.push(newVial);
                this.data.vials.sort((a, b) => new Date(b.reconstitution_date) - new Date(a.reconstitution_date));
                this.saveData();
                this.updateUI();
            }

            calculateExpirationDate(reconstitutionDate, orderDate) {
                if (reconstitutionDate) {
                    // Reconstituted peptide lasts 30 days in refrigerator
                    const date = new Date(reconstitutionDate);
                    date.setDate(date.getDate() + 30);
                    return date.toISOString();
                } else if (orderDate) {
                    // Lyophilized powder lasts 2 years in freezer
                    const date = new Date(orderDate);
                    date.setFullYear(date.getFullYear() + 2);
                    return date.toISOString();
                }
                // Default to 2 years from now
                const date = new Date();
                date.setFullYear(date.getFullYear() + 2);
                return date.toISOString();
            }

            getActiveVial() {
                const plannedDose = parseFloat(document.getElementById('planned-dose')?.value || 4.0);
                return this.data.vials.find(v => {
                    const remainingMg = v.remaining_ml * v.concentration_mg_ml;
                    return v.status === 'active' &&
                           remainingMg >= plannedDose && // Must have enough for next dose
                           new Date(v.expiration_date) > new Date();
                });
            }

            // ====================================
            // WEIGHT MANAGEMENT
            // ====================================

            addWeight(weight) {
                const newWeight = {
                    timestamp: weight.timestamp || new Date().toISOString(),
                    weight_kg: parseFloat(weight.weight_kg),
                    weight_lbs: this.kgToLbs(parseFloat(weight.weight_kg)),
                    source: weight.source || 'manual',
                    bmi: weight.bmi || null,
                    body_fat_percentage: weight.body_fat_percentage || null
                };

                this.data.weights.push(newWeight);
                this.data.weights.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                this.saveData();
                this.updateUI();
            }

            // ====================================
            // MEDICATION LEVEL CALCULATIONS
            // ====================================

            calculateCurrentMedicationLevel(currentTime = new Date().toISOString()) {
                const retatrutideHalfLife = 165; // 165 hours (about 7 days)
                const currentTimestamp = new Date(currentTime).getTime();
                let totalLevel = 0;

                this.data.injections.forEach(injection => {
                    const injectionTime = new Date(injection.timestamp).getTime();
                    const hoursElapsed = (currentTimestamp - injectionTime) / (1000 * 60 * 60);

                    if (hoursElapsed >= 0) {
                        const remainingLevel = injection.dose_mg * Math.pow(0.5, hoursElapsed / retatrutideHalfLife);
                        totalLevel += remainingLevel;
                    }
                });

                return totalLevel;
            }

            // ====================================
            // UTILITY FUNCTIONS
            // ====================================

            generateId() {
                return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            }

            kgToLbs(kg) {
                return kg * 2.20462;
            }

            lbsToKg(lbs) {
                return lbs / 2.20462;
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString();
            }

            formatDateTime(dateString) {
                return new Date(dateString).toLocaleString();
            }

            // ====================================
            // UI UPDATE FUNCTIONS
            // ====================================

            updateUI() {
                this.updateSummaryTab();
                this.updateShotsTab();
                this.updateResultsTab();
                this.updateInventoryTab();
                this.updateSettingsTab();
            }

            updateSummaryTab() {
                const totalShots = this.data.injections.length;
                const lastInjection = this.data.injections[0];
                const currentLevel = this.calculateCurrentMedicationLevel();
                const nextShotDays = this.calculateNextShotDays();

                document.getElementById('total-shots').textContent = totalShots;
                document.getElementById('last-dose').textContent = lastInjection ?
                    `${lastInjection.dose_mg} mg` : '0 mg';
                document.getElementById('current-level').textContent = `${currentLevel.toFixed(1)} mg`;
                document.getElementById('next-shot').textContent = `${nextShotDays} days`;

                this.updateCountdown();
                this.updateSupplyForecast();
            }

            updateShotsTab() {
                const shotsList = document.getElementById('shots-list');
                shotsList.innerHTML = '';

                this.data.injections.forEach(injection => {
                    const shotItem = this.createShotListItem(injection);
                    shotsList.appendChild(shotItem);
                });
            }

            updateResultsTab() {
                this.updateWeightChart();
                this.updateWeightStats();
            }

            updateInventoryTab() {
                const vialsList = document.getElementById('vials-list');
                vialsList.innerHTML = '';

                this.data.vials.forEach(vial => {
                    const vialItem = this.createVialListItem(vial);
                    vialsList.appendChild(vialItem);
                });

                this.updateInventoryStats();
            }

            updateSettingsTab() {
                document.getElementById('injection-frequency').value = this.data.settings.injectionFrequency;
            }

            calculateNextShotDays() {
                if (this.data.injections.length === 0) return 0;

                const lastShot = new Date(this.data.injections[0].timestamp);
                const nextShot = new Date(lastShot);
                nextShot.setDate(nextShot.getDate() + this.data.settings.injectionFrequency);

                const now = new Date();
                const diffTime = nextShot - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return Math.max(0, diffDays);
            }

            // ====================================
            // EVENT LISTENERS
            // ====================================

            setupEventListeners() {
                this.setupNavigation();
                this.setupModalHandlers();
                this.setupFormHandlers();
            }

            setupNavigation() {
                const navButtons = document.querySelectorAll('.nav-btn');
                const tabContents = document.querySelectorAll('.tab-content');

                navButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetTab = btn.dataset.tab;

                        navButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        tabContents.forEach(tab => {
                            tab.style.display = 'none';
                        });
                        document.getElementById(targetTab + '-tab').style.display = 'block';

                        // Update charts when switching tabs
                        if (targetTab === 'summary') this.updateSupplyForecast();
                        if (targetTab === 'results') this.updateWeightChart();
                    });
                });
            }

            hideLoadingScreen() {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('summary-tab').style.display = 'block';
                document.getElementById('current-date').textContent = new Date().toLocaleDateString();
            }

            // ====================================
            // PLACEHOLDER FUNCTIONS (TO BE IMPLEMENTED)
            // ====================================

            setupModalHandlers() {
                const overlay = document.getElementById('modal-overlay');
                const modals = document.querySelectorAll('.modal');

                // Add Shot Button handlers
                document.getElementById('add-shot-btn').addEventListener('click', () => {
                    this.openModal('add-shot-modal');
                });
                document.getElementById('add-shot-modal-btn').addEventListener('click', () => {
                    this.openModal('add-shot-modal');
                });

                // Add Vial Button handler
                document.getElementById('add-vial-btn').addEventListener('click', () => {
                    this.openModal('add-vial-modal');
                });

                // Results tab weight button (we'll add this)
                const addWeightBtn = document.createElement('button');
                addWeightBtn.textContent = 'Add Weight';
                addWeightBtn.className = 'btn-secondary';
                addWeightBtn.style.marginBottom = '16px';
                addWeightBtn.addEventListener('click', () => {
                    this.openModal('add-weight-modal');
                });
                document.querySelector('#results-tab .container').insertBefore(addWeightBtn, document.querySelector('#results-tab h2').nextSibling);

                // Close modal handlers
                document.querySelectorAll('.modal-close, [data-modal]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (btn.classList.contains('modal-close') || btn.textContent === 'Cancel') {
                            this.closeModal();
                        }
                    });
                });

                // Click outside modal to close
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        this.closeModal();
                    }
                });
            }

            setupFormHandlers() {
                // Add Shot Form
                document.getElementById('add-shot-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddShot();
                });

                // Add Vial Form
                document.getElementById('add-vial-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddVial();
                });

                // Add Weight Form
                document.getElementById('add-weight-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddWeight();
                });

                // Settings form handlers
                document.getElementById('injection-frequency').addEventListener('change', (e) => {
                    this.data.settings.injectionFrequency = parseInt(e.target.value);
                    this.saveData();
                    this.updateUI();
                });

                // Google Drive connection
                document.getElementById('google-drive-btn').addEventListener('click', () => {
                    if (typeof gapi !== 'undefined' && gapi.auth2) {
                        const isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();
                        if (isSignedIn) {
                            gapi.auth2.getAuthInstance().signOut();
                        } else {
                            gapi.auth2.getAuthInstance().signIn();
                        }
                    } else {
                        alert('Google Drive API not loaded. Please check your internet connection.');
                    }
                });

                // Withings connection
                document.getElementById('withings-btn').addEventListener('click', () => {
                    this.connectWithings();
                });

                // Export data
                document.getElementById('export-data-btn').addEventListener('click', () => {
                    this.exportData();
                });

                // Planned dose change listener
                const plannedDoseInput = document.getElementById('planned-dose');
                if (plannedDoseInput) {
                    plannedDoseInput.addEventListener('input', () => {
                        this.updateSupplyForecast();
                    });
                }

                // Import data
                document.getElementById('import-data-btn').addEventListener('click', () => {
                    this.importData();
                });
            }

            // ====================================
            // DATA EXPORT/IMPORT
            // ====================================

            exportData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `retatrutide_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                URL.revokeObjectURL(url);

                // Also generate CSV for injections
                this.exportInjectionsCSV();
            }

            exportInjectionsCSV() {
                if (this.data.injections.length === 0) {
                    alert('No injection data to export');
                    return;
                }

                const headers = ['Date', 'Time', 'Dose (mg)', 'Site', 'Weight (kg)', 'Notes'];
                const rows = this.data.injections.map(inj => {
                    const date = new Date(inj.timestamp);
                    return [
                        date.toLocaleDateString(),
                        date.toLocaleTimeString(),
                        inj.dose_mg,
                        inj.injection_site,
                        inj.weight_kg || '',
                        inj.notes || ''
                    ];
                });

                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(cell => `"${cell}"`).join(',') + '\n';
                });

                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `retatrutide_injections_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();

                URL.revokeObjectURL(url);
            }

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';

                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const importedData = JSON.parse(text);

                        if (confirm('This will replace all your current data. Are you sure?')) {
                            this.data = importedData;
                            await this.saveData();
                            this.updateUI();
                            alert('Data imported successfully!');
                        }
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };

                input.click();
            }

            openModal(modalId) {
                const overlay = document.getElementById('modal-overlay');
                const modal = document.getElementById(modalId);

                // Set current date/time for date inputs
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);

                if (modalId === 'add-shot-modal') {
                    document.getElementById('shot-date').value = localDateTime;
                    this.populateVialSelect();
                } else if (modalId === 'add-vial-modal') {
                    document.getElementById('vial-order-date').value = now.toISOString().split('T')[0];
                    document.getElementById('vial-reconstitution-date').value = localDateTime;
                } else if (modalId === 'add-weight-modal') {
                    document.getElementById('weight-date').value = localDateTime;
                }

                overlay.style.display = 'flex';
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                const overlay = document.getElementById('modal-overlay');
                const modals = document.querySelectorAll('.modal');

                overlay.style.display = 'none';
                modals.forEach(modal => modal.style.display = 'none');
                document.body.style.overflow = '';

                // Reset forms
                document.querySelectorAll('form').forEach(form => form.reset());
            }

            populateVialSelect() {
                const select = document.getElementById('shot-vial');
                select.innerHTML = '<option value="">Select vial</option>';

                const activeVials = this.data.vials.filter(v =>
                    v.status === 'active' &&
                    v.remaining_ml > 0 &&
                    new Date(v.expiration_date) > new Date()
                );

                activeVials.forEach(vial => {
                    const option = document.createElement('option');
                    option.value = vial.vial_id;
                    option.textContent = `${vial.total_mg}mg (${vial.concentration_mg_ml.toFixed(1)} mg/ml) - ${vial.remaining_ml.toFixed(1)}ml left`;
                    select.appendChild(option);
                });

                if (activeVials.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No active vials available';
                    option.disabled = true;
                    select.appendChild(option);
                }
            }

            handleAddShot() {
                const form = document.getElementById('add-shot-form');
                const formData = new FormData(form);

                const injection = {
                    timestamp: document.getElementById('shot-date').value,
                    dose_mg: parseFloat(document.getElementById('shot-dose').value),
                    injection_site: document.getElementById('shot-site').value,
                    vial_id: document.getElementById('shot-vial').value,
                    weight_kg: document.getElementById('shot-weight').value ?
                        parseFloat(document.getElementById('shot-weight').value) : null,
                    notes: document.getElementById('shot-notes').value
                };

                // Add weight entry if provided
                if (injection.weight_kg) {
                    this.addWeight({
                        timestamp: injection.timestamp,
                        weight_kg: injection.weight_kg,
                        source: 'manual'
                    });
                }

                this.addInjection(injection);
                this.closeModal();
            }

            handleAddVial() {
                const vial = {
                    order_date: document.getElementById('vial-order-date').value,
                    supplier: document.getElementById('vial-supplier').value,
                    lot_number: document.getElementById('vial-lot').value,
                    total_mg: parseFloat(document.getElementById('vial-mg').value),
                    bac_water_ml: parseFloat(document.getElementById('vial-bac-water').value),
                    reconstitution_date: document.getElementById('vial-reconstitution-date').value
                };

                this.addVial(vial);
                this.closeModal();
            }

            handleAddWeight() {
                const weight = {
                    timestamp: document.getElementById('weight-date').value,
                    weight_kg: parseFloat(document.getElementById('weight-kg').value),
                    body_fat_percentage: document.getElementById('weight-body-fat').value ?
                        parseFloat(document.getElementById('weight-body-fat').value) : null,
                    source: 'manual'
                };

                this.addWeight(weight);
                this.closeModal();
            }

            createShotListItem(injection) {
                const div = document.createElement('div');
                div.className = 'shot-item';
                div.innerHTML = `
                    <div class="shot-header">
                        <div class="shot-dose">${injection.dose_mg} mg</div>
                        <div class="shot-date">${this.formatDate(injection.timestamp)}</div>
                    </div>
                    <div class="shot-details">
                        <div>Site: ${injection.injection_site}</div>
                        <div>Weight: ${injection.weight_kg ? injection.weight_kg + ' kg' : 'N/A'}</div>
                    </div>
                `;
                return div;
            }

            createVialListItem(vial) {
                const div = document.createElement('div');
                div.className = 'vial-item';

                const now = new Date();
                const expirationDate = new Date(vial.expiration_date);
                const isExpired = expirationDate < now;
                const daysUntilExpiry = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));

                let status = 'active';
                let statusText = 'Active';

                if (isExpired) {
                    status = 'expired';
                    statusText = 'Expired';
                } else if (daysUntilExpiry <= 3) {
                    status = 'expiring';
                    statusText = `${daysUntilExpiry}d left`;
                } else if (vial.remaining_ml <= 0) {
                    status = 'empty';
                    statusText = 'Empty';
                }

                // Calculate remaining doses based on average 2mg dose
                const remainingDoses = Math.floor((vial.remaining_ml * vial.concentration_mg_ml) / 2.0);

                div.innerHTML = `
                    <div class="vial-header">
                        <div class="vial-info">
                            <div class="vial-title">${vial.total_mg}mg Vial</div>
                            <div class="vial-subtitle">${vial.supplier} ${vial.lot_number ? '- ' + vial.lot_number : ''}</div>
                            <div class="vial-subtitle">Ordered: ${this.formatDate(vial.order_date)}</div>
                        </div>
                        <div class="vial-status ${status}">${statusText}</div>
                    </div>
                    <div class="vial-details">
                        <div class="vial-detail-row">
                            <span>Concentration:</span>
                            <span>${vial.concentration_mg_ml.toFixed(1)} mg/ml</span>
                        </div>
                        <div class="vial-detail-row">
                            <span>Remaining:</span>
                            <span>${vial.remaining_ml.toFixed(2)} ml (${remainingDoses} doses)</span>
                        </div>
                        <div class="vial-detail-row">
                            <span>Reconstituted:</span>
                            <span>${this.formatDate(vial.reconstitution_date)}</span>
                        </div>
                        <div class="vial-detail-row">
                            <span>Expires:</span>
                            <span>${this.formatDate(vial.expiration_date)}</span>
                        </div>
                        <div class="vial-detail-row">
                            <span>Doses Used:</span>
                            <span>${vial.doses_used}</span>
                        </div>
                    </div>
                `;
                return div;
            }

            updateSupplyForecast() {
                // Calculate total remaining supply
                const activeVials = this.data.vials.filter(v =>
                    v.status === 'active' &&
                    v.remaining_ml > 0 &&
                    new Date(v.expiration_date) > new Date()
                );

                let totalSupplyMg = 0;
                activeVials.forEach(vial => {
                    totalSupplyMg += vial.remaining_ml * vial.concentration_mg_ml;
                });

                // Get planned dose from input
                const plannedDoseInput = document.getElementById('planned-dose');
                const plannedWeeklyDose = parseFloat(plannedDoseInput?.value || 4.0);

                // Calculate duration
                const weeksRemaining = plannedWeeklyDose > 0 ? Math.floor(totalSupplyMg / plannedWeeklyDose) : 0;
                const daysRemaining = weeksRemaining * 7;

                // Calculate run out date
                const runOutDate = new Date();
                runOutDate.setDate(runOutDate.getDate() + daysRemaining);

                // Calculate reorder date (2 weeks before running out)
                const reorderDays = Math.max(0, daysRemaining - 14);

                // Update display
                document.getElementById('total-supply').textContent = `${totalSupplyMg.toFixed(1)} mg`;
                document.getElementById('supply-duration').textContent = `${weeksRemaining} weeks (${daysRemaining} days)`;
                document.getElementById('run-out-date').textContent = daysRemaining > 0 ? runOutDate.toLocaleDateString() : 'No supply';
                document.getElementById('reorder-days').textContent = reorderDays > 0 ? `${reorderDays} days` : 'Order now!';

                // Update colors based on supply levels
                const supplyDurationElement = document.getElementById('supply-duration');
                const runOutElement = document.getElementById('run-out-date');
                const reorderElement = document.getElementById('reorder-days');

                if (daysRemaining < 7) {
                    supplyDurationElement.style.color = '#FF3B30'; // Red
                    runOutElement.style.color = '#FF3B30';
                    reorderElement.style.color = '#FF3B30';
                } else if (daysRemaining < 21) {
                    supplyDurationElement.style.color = '#FF9500'; // Orange
                    runOutElement.style.color = '#FF9500';
                    reorderElement.style.color = '#FF9500';
                } else {
                    supplyDurationElement.style.color = '#34C759'; // Green
                    runOutElement.style.color = '#34C759';
                    reorderElement.style.color = '#34C759';
                }
            }

            updateMedicationChart() {
                // Keeping old function for compatibility - now calls updateSupplyForecast
                this.updateSupplyForecast();
                return;

                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded, skipping chart update');
                    return;
                }

                // Destroy existing chart if it exists
                if (this.charts.medicationChart) {
                    this.charts.medicationChart.destroy();
                }

                if (this.data.injections.length === 0) {
                    // Show empty state
                    ctx.fillStyle = '#888888';
                    ctx.font = '16px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('No injection data yet', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const chartData = this.generateMedicationLevelData();

                this.charts.medicationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Medication Level',
                            data: chartData.levels,
                            borderColor: '#007AFF',
                            backgroundColor: 'rgba(0, 122, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#007AFF',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }, {
                            label: 'Projected Level',
                            data: chartData.projectedLevels,
                            borderColor: '#007AFF',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#ffffff',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(42, 42, 42, 0.9)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#333333',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#333333'
                                },
                                ticks: {
                                    color: '#cccccc',
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: '#333333'
                                },
                                ticks: {
                                    color: '#cccccc',
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value.toFixed(1) + ' mg';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Medication Level (mg)',
                                    color: '#cccccc'
                                }
                            }
                        }
                    }
                });
            }

            generateMedicationLevelData() {
                const now = new Date();
                const startDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000)); // 30 days ago
                const endDate = new Date(now.getTime() + (14 * 24 * 60 * 60 * 1000)); // 14 days in future

                const labels = [];
                const levels = [];
                const projectedLevels = [];

                // Generate data points every 6 hours
                for (let date = new Date(startDate); date <= endDate; date = new Date(date.getTime() + 6 * 60 * 60 * 1000)) {
                    const level = this.calculateCurrentMedicationLevel(date.toISOString());
                    const isProjected = date > now;

                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                    if (isProjected) {
                        levels.push(null);
                        projectedLevels.push(level);
                    } else {
                        levels.push(level);
                        projectedLevels.push(null);
                    }
                }

                return { labels, levels, projectedLevels };
            }

            updateWeightChart() {
                const canvas = document.getElementById('weight-chart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded, skipping weight chart update');
                    return;
                }

                // Destroy existing chart if it exists
                if (this.charts.weightChart) {
                    this.charts.weightChart.destroy();
                }

                if (this.data.weights.length === 0) {
                    // Show empty state
                    ctx.fillStyle = '#888888';
                    ctx.font = '16px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('No weight data yet', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const sortedWeights = [...this.data.weights].sort((a, b) =>
                    new Date(a.timestamp) - new Date(b.timestamp)
                );

                const sortedInjections = [...this.data.injections].sort((a, b) =>
                    new Date(a.timestamp) - new Date(b.timestamp)
                );

                this.charts.weightChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Weight (kg)',
                            data: sortedWeights.map(w => ({
                                x: w.timestamp,
                                y: w.weight_kg
                            })),
                            borderColor: '#34C759',
                            backgroundColor: 'rgba(52, 199, 89, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointBackgroundColor: function(context) {
                                const weight = sortedWeights[context.dataIndex];
                                return weight.source === 'withings' ? '#FF9500' : '#34C759';
                            }
                        }, {
                            label: 'Dose (mg)',
                            data: sortedInjections.map(i => ({
                                x: i.timestamp,
                                y: i.dose_mg
                            })),
                            type: 'scatter',
                            backgroundColor: '#007AFF',
                            borderColor: '#007AFF',
                            pointRadius: 6,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#ffffff',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(42, 42, 42, 0.9)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#333333',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    displayFormats: {
                                        day: 'MMM d'
                                    }
                                },
                                grid: {
                                    color: '#333333'
                                },
                                ticks: {
                                    color: '#cccccc'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                grid: {
                                    color: '#333333'
                                },
                                ticks: {
                                    color: '#cccccc',
                                    callback: function(value) {
                                        return value.toFixed(1) + ' kg';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Weight (kg)',
                                    color: '#34C759'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    color: '#cccccc',
                                    callback: function(value) {
                                        return value.toFixed(1) + ' mg';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Dose (mg)',
                                    color: '#007AFF'
                                }
                            }
                        }
                    }
                });
            }

            updateWeightStats() {
                if (this.data.weights.length < 2) {
                    document.getElementById('weight-change').textContent = '0 kg';
                    document.getElementById('current-weight').textContent = '0 kg';
                    return;
                }

                const sortedWeights = [...this.data.weights].sort((a, b) =>
                    new Date(a.timestamp) - new Date(b.timestamp)
                );

                const firstWeight = sortedWeights[0];
                const lastWeight = sortedWeights[sortedWeights.length - 1];

                const weightChangeKg = lastWeight.weight_kg - firstWeight.weight_kg;

                const changeText = weightChangeKg >= 0 ?
                    `+${Math.abs(weightChangeKg).toFixed(1)} kg` :
                    `-${Math.abs(weightChangeKg).toFixed(1)} kg`;

                document.getElementById('weight-change').textContent = changeText;
                document.getElementById('current-weight').textContent =
                    `${lastWeight.weight_kg.toFixed(1)} kg`;

                // Update color based on weight change
                const weightChangeElement = document.getElementById('weight-change');
                if (weightChangeKg < 0) {
                    weightChangeElement.style.color = '#34C759'; // Green for weight loss
                } else if (weightChangeKg > 0) {
                    weightChangeElement.style.color = '#FF9500'; // Orange for weight gain
                } else {
                    weightChangeElement.style.color = '#888888'; // Gray for no change
                }
            }

            updateInventoryStats() {
                const activeVials = this.data.vials.filter(v =>
                    v.status === 'active' &&
                    v.remaining_ml > 0 &&
                    new Date(v.expiration_date) > new Date()
                );

                const expiredVials = this.data.vials.filter(v =>
                    new Date(v.expiration_date) < new Date()
                );

                let totalDoses = 0;
                let totalMgUsed = 0;

                activeVials.forEach(vial => {
                    const dosesInVial = Math.floor((vial.remaining_ml * vial.concentration_mg_ml) / 2.0); // Assuming 2mg average dose
                    totalDoses += dosesInVial;
                });

                this.data.vials.forEach(vial => {
                    totalMgUsed += vial.doses_used * 2.0; // Assuming 2mg average dose
                });

                const daysRemaining = Math.floor(totalDoses * this.data.settings.injectionFrequency);


                // Update basic stats
                document.getElementById('total-stock').textContent = totalDoses;
                document.getElementById('days-remaining').textContent = daysRemaining;
                // Cost fields removed - no longer tracking costs

                // Update colors based on stock levels
                const stockElement = document.getElementById('total-stock');
                const daysElement = document.getElementById('days-remaining');

                if (totalDoses < 5 || daysRemaining < 14) {
                    stockElement.style.color = '#FF3B30'; // Red for low stock
                    daysElement.style.color = '#FF3B30';
                } else if (totalDoses < 10 || daysRemaining < 30) {
                    stockElement.style.color = '#FF9500'; // Orange for medium stock
                    daysElement.style.color = '#FF9500';
                } else {
                    stockElement.style.color = '#34C759'; // Green for good stock
                    daysElement.style.color = '#34C759';
                }

                // Update analytics
                this.updateInventoryAnalytics(totalDoses, daysRemaining, expiredVials);
            }

            updateInventoryAnalytics(totalDoses, daysRemaining, expiredVials) {
                // Reorder Alert
                let reorderAlert = "Stock levels look good";
                let reorderColor = '#34C759';

                if (totalDoses < 3 || daysRemaining < 7) {
                    reorderAlert = "üö® Critical - Order immediately!";
                    reorderColor = '#FF3B30';
                } else if (totalDoses < 5 || daysRemaining < 14) {
                    reorderAlert = "‚ö†Ô∏è Low stock - Order soon";
                    reorderColor = '#FF9500';
                } else if (totalDoses < 8 || daysRemaining < 21) {
                    reorderAlert = "üìã Consider ordering";
                    reorderColor = '#FF9500';
                }

                const reorderElement = document.getElementById('reorder-alert');
                reorderElement.textContent = reorderAlert;
                reorderElement.style.color = reorderColor;

                // Usage Rate
                let usageRate = "Calculating...";
                if (this.data.injections.length >= 2) {
                    const injectionDays = this.data.injections.length * this.data.settings.injectionFrequency;
                    const totalMg = this.data.injections.reduce((sum, inj) => sum + inj.dose_mg, 0);
                    const avgDosePerWeek = (totalMg / injectionDays) * 7;
                    usageRate = `${avgDosePerWeek.toFixed(1)} mg/week average`;
                }
                document.getElementById('usage-rate').textContent = usageRate;

                // Waste Tracking
                let wasteText = "No expired vials";
                let wasteColor = '#34C759';

                if (expiredVials.length > 0) {
                    const expiredMg = expiredVials.reduce((sum, vial) => {
                        return sum + (vial.remaining_ml * vial.concentration_mg_ml);
                    }, 0);
                    wasteText = `${expiredVials.length} expired (${expiredMg.toFixed(0)}mg lost)`;
                    wasteColor = '#FF3B30';
                }

                const wasteElement = document.getElementById('waste-tracking');
                wasteElement.textContent = wasteText;
                wasteElement.style.color = wasteColor;

                // Next Order Suggestion
                let nextOrderText = "Order in 30+ days";
                let nextOrderColor = '#34C759';

                if (daysRemaining <= 14) {
                    nextOrderText = "Order now!";
                    nextOrderColor = '#FF3B30';
                } else if (daysRemaining <= 30) {
                    nextOrderText = `Order in ${Math.max(0, daysRemaining - 14)} days`;
                    nextOrderColor = '#FF9500';
                } else {
                    const orderInDays = Math.max(daysRemaining - 21, 1);
                    nextOrderText = `Order in ${orderInDays} days`;
                }

                const nextOrderElement = document.getElementById('next-order');
                nextOrderElement.textContent = nextOrderText;
                nextOrderElement.style.color = nextOrderColor;
            }

            // ====================================
            // COUNTDOWN FUNCTIONALITY
            // ====================================

            startCountdownTimer() {
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                }

                this.countdownInterval = setInterval(() => {
                    this.updateCountdown();
                }, 1000);
            }

            updateCountdown() {
                if (this.data.injections.length === 0) {
                    document.getElementById('countdown-days').textContent = '0';
                    document.getElementById('countdown-time').textContent = '00:00:00';
                    this.updateCountdownProgress(0);
                    return;
                }

                const now = new Date();
                const lastShot = new Date(this.data.injections[0].timestamp);

                // Find the next Saturday
                let nextShot = new Date(now);
                const currentDay = now.getDay();

                // If today is Sunday (0) through Friday (5), go to next Saturday
                // If today is Saturday (6), check if we've had our shot today
                if (currentDay === 6) {
                    // It's Saturday - check if last shot was today
                    const lastShotDate = new Date(lastShot);
                    lastShotDate.setHours(0, 0, 0, 0);
                    const today = new Date(now);
                    today.setHours(0, 0, 0, 0);

                    if (lastShotDate.getTime() === today.getTime()) {
                        // Shot was today, next one is next Saturday
                        nextShot.setDate(nextShot.getDate() + 7);
                    }
                    // Otherwise, shot is due today
                } else {
                    // Calculate days until Saturday (6)
                    const daysUntilSaturday = (6 - currentDay + 7) % 7;
                    nextShot.setDate(nextShot.getDate() + daysUntilSaturday);
                }

                // Set time to 9 AM for the shot
                nextShot.setHours(9, 0, 0, 0);

                // Use the already declared 'now' variable
                const timeDiff = nextShot.getTime() - now.getTime();

                if (timeDiff <= 0) {
                    // Shot is overdue
                    document.getElementById('countdown-days').textContent = 'OVERDUE';
                    document.getElementById('countdown-time').textContent = '';
                    this.updateCountdownProgress(100);
                    document.querySelector('.countdown-days').style.color = '#FF3B30';
                    return;
                }

                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

                document.getElementById('countdown-days').textContent = days;
                document.getElementById('countdown-time').textContent =
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Calculate progress (percentage of time elapsed since last shot)
                const totalTime = this.data.settings.injectionFrequency * 24 * 60 * 60 * 1000; // Total interval in ms
                const elapsedTime = now.getTime() - lastShot.getTime();
                const progress = Math.min(100, (elapsedTime / totalTime) * 100);

                this.updateCountdownProgress(progress);

                // Update color based on how close to next shot
                const countdownDays = document.querySelector('.countdown-days');
                if (days === 0) {
                    countdownDays.style.color = '#FF9500'; // Orange for today
                } else if (days === 1) {
                    countdownDays.style.color = '#FF9500'; // Orange for tomorrow
                } else {
                    countdownDays.style.color = '#007AFF'; // Blue for normal
                }
            }

            updateCountdownProgress(percentage) {
                const circle = document.getElementById('countdown-circle');
                const circumference = 2 * Math.PI * 90; // radius = 90
                const offset = circumference - (percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }

            // ====================================
            // GOOGLE DRIVE INTEGRATION
            // ====================================

            async initGoogleDrive() {
                // Google API client ID (you'll need to replace this with your own)
                this.CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
                this.API_KEY = 'YOUR_GOOGLE_API_KEY';
                this.DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
                this.SCOPES = 'https://www.googleapis.com/auth/drive.appdata';

                this.loadGoogleAPI();
            }

            loadGoogleAPI() {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => this.handleGoogleAPILoad();
                document.body.appendChild(script);
            }

            handleGoogleAPILoad() {
                gapi.load('client:auth2', () => {
                    gapi.client.init({
                        apiKey: this.API_KEY,
                        clientId: this.CLIENT_ID,
                        discoveryDocs: this.DISCOVERY_DOCS,
                        scope: this.SCOPES
                    }).then(() => {
                        // Listen for sign-in state changes
                        gapi.auth2.getAuthInstance().isSignedIn.listen((isSignedIn) => {
                            this.handleGoogleSignInStatus(isSignedIn);
                        });

                        // Handle initial sign-in state
                        this.handleGoogleSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                    });
                });
            }

            handleGoogleSignInStatus(isSignedIn) {
                const connectBtn = document.getElementById('google-drive-btn');
                if (isSignedIn) {
                    connectBtn.textContent = 'Disconnect Google Drive';
                    connectBtn.classList.add('connected');
                    this.data.settings.googleDriveConnected = true;
                    this.syncToGoogleDrive();
                } else {
                    connectBtn.textContent = 'Connect Google Drive';
                    connectBtn.classList.remove('connected');
                    this.data.settings.googleDriveConnected = false;
                }
                this.saveData();
            }

            async syncToGoogleDrive() {
                if (!this.data.settings.googleDriveConnected) {
                    console.log('Google Drive not connected');
                    return;
                }

                try {
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";

                    const metadata = {
                        'name': 'retatrutide_data.json',
                        'mimeType': 'application/json',
                        'parents': ['appDataFolder']
                    };

                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(this.data) +
                        close_delim;

                    // Check if file exists
                    const response = await gapi.client.drive.files.list({
                        'spaces': 'appDataFolder',
                        'fields': 'files(id, name)',
                        'pageSize': 10
                    });

                    const files = response.result.files;
                    let fileId = null;

                    if (files && files.length > 0) {
                        fileId = files[0].id;
                    }

                    if (fileId) {
                        // Update existing file
                        await gapi.client.request({
                            'path': `/upload/drive/v3/files/${fileId}`,
                            'method': 'PATCH',
                            'params': {'uploadType': 'multipart'},
                            'headers': {
                                'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                            },
                            'body': multipartRequestBody
                        });
                        console.log('Data synced to Google Drive');
                    } else {
                        // Create new file
                        await gapi.client.request({
                            'path': '/upload/drive/v3/files',
                            'method': 'POST',
                            'params': {'uploadType': 'multipart'},
                            'headers': {
                                'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                            },
                            'body': multipartRequestBody
                        });
                        console.log('Data uploaded to Google Drive');
                    }

                    this.data.settings.lastSync = new Date().toISOString();
                    this.updateSyncStatus();
                } catch (error) {
                    console.error('Error syncing to Google Drive:', error);
                }
            }

            async loadFromGoogleDrive() {
                if (!this.data.settings.googleDriveConnected) return;

                try {
                    const response = await gapi.client.drive.files.list({
                        'spaces': 'appDataFolder',
                        'fields': 'files(id, name)',
                        'pageSize': 10
                    });

                    const files = response.result.files;
                    if (files && files.length > 0) {
                        const file = await gapi.client.drive.files.get({
                            'fileId': files[0].id,
                            'alt': 'media'
                        });

                        const cloudData = JSON.parse(file.body);

                        // Merge cloud data with local data (prefer newer)
                        if (cloudData.settings && cloudData.settings.lastSync) {
                            const cloudTime = new Date(cloudData.settings.lastSync);
                            const localTime = this.data.settings.lastSync ? new Date(this.data.settings.lastSync) : new Date(0);

                            if (cloudTime > localTime) {
                                this.data = cloudData;
                                await this.saveData();
                                this.updateUI();
                                console.log('Loaded data from Google Drive');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading from Google Drive:', error);
                }
            }

            updateSyncStatus() {
                if (this.data.settings.lastSync) {
                    const lastSync = new Date(this.data.settings.lastSync);
                    const syncStatus = document.createElement('div');
                    syncStatus.className = 'sync-status';
                    syncStatus.textContent = `Last synced: ${lastSync.toLocaleString()}`;

                    const settingsContainer = document.querySelector('#settings-tab .container');
                    const existingStatus = settingsContainer.querySelector('.sync-status');
                    if (existingStatus) {
                        existingStatus.textContent = syncStatus.textContent;
                    } else {
                        settingsContainer.appendChild(syncStatus);
                    }
                }
            }

            // ====================================
            // WITHINGS HEALTH API INTEGRATION
            // ====================================

            connectWithings() {
                // Withings OAuth 2.0 configuration
                // Replace with your actual Withings Client ID from developer.withings.com
                const WITHINGS_CLIENT_ID = 'YOUR_WITHINGS_CLIENT_ID';

                // Check if client ID has been configured
                if (WITHINGS_CLIENT_ID === 'YOUR_WITHINGS_CLIENT_ID') {
                    alert('Withings integration not configured. Please update WITHINGS_CLIENT_ID with your actual client ID from developer.withings.com');
                    return;
                }
                const WITHINGS_REDIRECT_URI = window.location.origin + '/withings-callback';
                const WITHINGS_AUTH_URL = 'https://account.withings.com/oauth2_user/authorize2';

                // Generate state for security
                const state = Math.random().toString(36).substring(2, 15);
                sessionStorage.setItem('withings_state', state);

                // Build authorization URL
                const params = new URLSearchParams({
                    response_type: 'code',
                    client_id: WITHINGS_CLIENT_ID,
                    scope: 'user.metrics',
                    redirect_uri: WITHINGS_REDIRECT_URI,
                    state: state
                });

                const authUrl = `${WITHINGS_AUTH_URL}?${params.toString()}`;

                // For demo purposes, show configuration instructions
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-header">
                        <h3 class="modal-title">Connect Withings Health</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.remove(); document.getElementById('modal-overlay').style.display='none';">&times;</button>
                    </div>
                    <div class="modal-content">
                        <p>To enable Withings integration:</p>
                        <ol>
                            <li>Register your app at <a href="https://developer.withings.com" target="_blank">developer.withings.com</a></li>
                            <li>Get your Client ID and Secret</li>
                            <li>Update the WITHINGS_CLIENT_ID in this app</li>
                            <li>Configure OAuth redirect URL</li>
                        </ol>
                        <p>Once configured, this will allow automatic import of:</p>
                        <ul>
                            <li>Weight measurements</li>
                            <li>Body fat percentage</li>
                            <li>BMI calculations</li>
                            <li>Historical data</li>
                        </ul>
                        <button class="btn-primary" onclick="window.open('${authUrl}', '_blank')">Proceed to Withings</button>
                    </div>
                `;

                document.getElementById('modal-overlay').style.display = 'flex';
                document.getElementById('modal-overlay').appendChild(modal);
            }

            async handleWithingsCallback(code) {
                // This would handle the OAuth callback
                // Exchange code for access token
                // Store token securely
                // Fetch user data
                console.log('Withings callback handling for code:', code);

                // For production, implement token exchange and data fetching
                this.data.settings.withingsConnected = true;
                await this.saveData();
                this.fetchWithingsData();
            }

            async fetchWithingsData() {
                if (!this.data.settings.withingsConnected) return;

                try {
                    // In production, this would use the Withings API
                    // For now, simulate the API response structure
                    const mockWithingsData = {
                        body: {
                            measuregrps: [
                                {
                                    date: Math.floor(Date.now() / 1000),
                                    measures: [
                                        {
                                            value: 82500, // 82.5 kg
                                            type: 1, // Weight
                                            unit: -3 // kg
                                        },
                                        {
                                            value: 185, // 18.5%
                                            type: 6, // Fat percentage
                                            unit: -1
                                        }
                                    ]
                                }
                            ]
                        }
                    };

                    // Process Withings data
                    mockWithingsData.body.measuregrps.forEach(group => {
                        const timestamp = new Date(group.date * 1000).toISOString();
                        let weight_kg = null;
                        let body_fat_percentage = null;

                        group.measures.forEach(measure => {
                            if (measure.type === 1) { // Weight
                                weight_kg = measure.value * Math.pow(10, measure.unit);
                            } else if (measure.type === 6) { // Fat percentage
                                body_fat_percentage = measure.value * Math.pow(10, measure.unit);
                            }
                        });

                        if (weight_kg) {
                            // Check if we already have this weight entry
                            const existingEntry = this.data.weights.find(w =>
                                Math.abs(new Date(w.timestamp) - new Date(timestamp)) < 60000 // Within 1 minute
                            );

                            if (!existingEntry) {
                                this.addWeight({
                                    timestamp: timestamp,
                                    weight_kg: weight_kg,
                                    body_fat_percentage: body_fat_percentage,
                                    source: 'withings'
                                });
                            }
                        }
                    });

                    console.log('Withings data fetched and processed');
                } catch (error) {
                    console.error('Error fetching Withings data:', error);
                }
            }

            // ====================================
            // PWA FUNCTIONALITY
            // ====================================

            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/reta/sw.js')
                        .then(registration => {
                            console.log('Service Worker registered successfully:', registration.scope);
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
            }

            requestNotificationPermission() {
                if ('Notification' in window && navigator.serviceWorker) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('Notification permission granted');
                        }
                    });
                }
            }

            scheduleNotification(title, body, delayInMs) {
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    setTimeout(() => {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification(title, {
                                body: body,
                                icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="64" height="64"%3E%3Crect width="64" height="64" fill="%231a1a1a"/%3E%3Ctext x="50%25" y="50%25" font-family="sans-serif" font-size="16" fill="white" text-anchor="middle" dominant-baseline="central"%3ESR%3C/text%3E%3C/svg%3E',
                                vibrate: [100, 50, 100]
                            });
                        });
                    }, delayInMs);
                }
            }
        }

        // ====================================
        // INITIALIZE APPLICATION
        // ====================================

        let app;

        document.addEventListener('DOMContentLoaded', function() {
            app = new RetatrutideTracker();
            app.registerServiceWorker();
            app.requestNotificationPermission();

            // Handle URL parameters for PWA shortcuts
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'add_shot') {
                setTimeout(() => app.openModal('add-shot-modal'), 500);
            } else if (urlParams.get('tab')) {
                const tab = urlParams.get('tab');
                setTimeout(() => {
                    document.querySelector(`[data-tab="${tab}"]`)?.click();
                }, 500);
            }
        });
    </script>
</body>
</html>